{"version":3,"file":"moonlabClient-D-rb-4O8.js","sources":["../../bindings/javascript/demo/src/workers/moonlabClient.ts"],"sourcesContent":["export type WorkerGate = {\n  type: string;\n  qubit: number;\n  controlQubit?: number;\n  controlQubit2?: number;\n  angle?: number;\n};\n\ntype WorkerResult<T> = {\n  id: number;\n  ok: boolean;\n  result?: T;\n  error?: string;\n};\n\ntype PendingRequest = {\n  resolve: (value: any) => void;\n  reject: (error: Error) => void;\n};\n\nlet worker: Worker | null = null;\nlet nextId = 1;\nconst pending = new Map<number, PendingRequest>();\nlet initPromise: Promise<void> | null = null;\n\nconst getWorker = (): Worker => {\n  if (worker) return worker;\n  if (typeof window === 'undefined') {\n    throw new Error('Moonlab worker is only available in the browser');\n  }\n  const url = new URL('moonlab-worker.js', window.location.href);\n  worker = new Worker(url, { type: 'classic' });\n  worker.onmessage = (event: MessageEvent<WorkerResult<any>>) => {\n    const message = event.data;\n    const handler = pending.get(message.id);\n    if (!handler) return;\n    pending.delete(message.id);\n    if (message.ok) {\n      handler.resolve(message.result);\n    } else {\n      handler.reject(new Error(message.error || 'Worker error'));\n    }\n  };\n  worker.onerror = (event) => {\n    pending.forEach(({ reject }) => reject(new Error(event.message)));\n    pending.clear();\n  };\n  return worker;\n};\n\nconst callWorker = async <T>(\n  type: string,\n  payload?: any,\n  transfer?: Transferable[]\n): Promise<T> => {\n  const instance = getWorker();\n  const id = nextId++;\n  const response = new Promise<T>((resolve, reject) => {\n    pending.set(id, { resolve, reject });\n  });\n  instance.postMessage({ id, type, payload }, transfer || []);\n  return response;\n};\n\nexport const ensureMoonlabWorker = async (): Promise<void> => {\n  if (!initPromise) {\n    initPromise = callWorker<{ ready: boolean }>('init').then(() => undefined);\n  }\n  return initPromise;\n};\n\nexport const runCircuitInWorker = async (payload: {\n  numQubits: number;\n  gates: WorkerGate[];\n}): Promise<{ probabilities: Float64Array; warnings: string[] }> => {\n  const result = await callWorker<{ probabilities: Float64Array; warnings: string[] }>(\n    'runCircuit',\n    payload\n  );\n  return result;\n};\n\nexport const probabilitiesFromAmplitudes = async (payload: {\n  numQubits: number;\n  amplitudes: Float64Array;\n}): Promise<Float64Array> => {\n  const result = await callWorker<{ probabilities: Float64Array }>(\n    'probabilitiesFromAmplitudes',\n    payload,\n    [payload.amplitudes.buffer]\n  );\n  return result.probabilities;\n};\n\nexport const dmrgWeightsInWorker = async (payload: {\n  numSites: number;\n  g: number;\n}): Promise<{\n  weights: Float64Array;\n  energy?: number;\n  variance?: number;\n  elapsedMs: number;\n}> => {\n  const result = await callWorker<{\n    weights: Float64Array;\n    energy?: number;\n    variance?: number;\n    elapsedMs: number;\n  }>('dmrgWeights', payload);\n  return result;\n};\n"],"names":["worker","nextId","pending","initPromise","getWorker","url","event","message","handler","reject","callWorker","type","payload","transfer","instance","id","response","resolve","ensureMoonlabWorker","runCircuitInWorker","probabilitiesFromAmplitudes","dmrgWeightsInWorker"],"mappings":"AAoBA,IAAIA,EAAwB,KACxBC,EAAS,EACb,MAAMC,MAAc,IACpB,IAAIC,EAAoC,KAExC,MAAMC,EAAY,IAAc,CAC9B,GAAIJ,EAAQ,OAAOA,EACnB,GAAI,OAAO,OAAW,IACpB,MAAM,IAAI,MAAM,iDAAiD,EAEnE,MAAMK,EAAM,IAAI,IAAI,oBAAqB,OAAO,SAAS,IAAI,EAC7D,OAAAL,EAAS,IAAI,OAAOK,EAAK,CAAE,KAAM,UAAW,EAC5CL,EAAO,UAAaM,GAA2C,CAC7D,MAAMC,EAAUD,EAAM,KAChBE,EAAUN,EAAQ,IAAIK,EAAQ,EAAE,EACjCC,IACLN,EAAQ,OAAOK,EAAQ,EAAE,EACrBA,EAAQ,GACVC,EAAQ,QAAQD,EAAQ,MAAM,EAE9BC,EAAQ,OAAO,IAAI,MAAMD,EAAQ,OAAS,cAAc,CAAC,EAE7D,EACAP,EAAO,QAAWM,GAAU,CAC1BJ,EAAQ,QAAQ,CAAC,CAAE,OAAAO,CAAA,IAAaA,EAAO,IAAI,MAAMH,EAAM,OAAO,CAAC,CAAC,EAChEJ,EAAQ,MAAA,CACV,EACOF,CACT,EAEMU,EAAa,MACjBC,EACAC,EACAC,IACe,CACf,MAAMC,EAAWV,EAAA,EACXW,EAAKd,IACLe,EAAW,IAAI,QAAW,CAACC,EAASR,IAAW,CACnDP,EAAQ,IAAIa,EAAI,CAAE,QAAAE,EAAS,OAAAR,EAAQ,CACrC,CAAC,EACD,OAAAK,EAAS,YAAY,CAAE,GAAAC,EAAI,KAAAJ,EAAM,QAAAC,GAAWC,GAAY,EAAE,EACnDG,CACT,EAEaE,EAAsB,UAC5Bf,IACHA,EAAcO,EAA+B,MAAM,EAAE,KAAK,IAAA,EAAe,GAEpEP,GAGIgB,EAAqB,MAAOP,GAIxB,MAAMF,EACnB,aACAE,CAAA,EAKSQ,EAA8B,MAAOR,IAIjC,MAAMF,EACnB,8BACAE,EACA,CAACA,EAAQ,WAAW,MAAM,CAAA,GAEd,cAGHS,EAAsB,MAAOT,GASzB,MAAMF,EAKlB,cAAeE,CAAO"}