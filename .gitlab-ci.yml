stages:
  - build
  - test

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# =============================================================================
# Hidden job templates
# =============================================================================

.linux-base:
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y build-essential libomp-dev libopenblas-dev liblapacke-dev

# =============================================================================
# Build jobs
# =============================================================================

build-linux-x86:
  extends: .linux-base
  stage: build
  script:
    - make clean && make
    - make tests unit_tests
  artifacts:
    paths:
      - lib/
      - obj/
      - tests/
      - qsim_test
    expire_in: 1 hour

build-linux-arm64:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker
  before_script:
    - apt-get update
    - apt-get install -y docker.io qemu-user-static
  script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx build --platform linux/arm64 -f docker/debian/release/Dockerfile --load -t moonlab-arm64:latest .
  allow_failure: true

# =============================================================================
# Test jobs
# =============================================================================

test-unit:
  extends: .linux-base
  stage: test
  needs: [build-linux-x86]
  script:
    - LD_LIBRARY_PATH=. ./tests/unit/test_memory_align
    - LD_LIBRARY_PATH=. ./tests/unit/test_simd_dispatch
    - LD_LIBRARY_PATH=. ./tests/unit/test_stride_gates
    - LD_LIBRARY_PATH=. ./tests/unit/test_quantum_state
    - LD_LIBRARY_PATH=. ./tests/unit/test_quantum_gates
    - LD_LIBRARY_PATH=. ./tests/unit/test_tensor_network

test-integration:
  extends: .linux-base
  stage: test
  needs: [build-linux-x86]
  script:
    - LD_LIBRARY_PATH=. ./qsim_test
    - LD_LIBRARY_PATH=. ./tests/health_tests_test
    - LD_LIBRARY_PATH=. ./tests/gate_test
    - LD_LIBRARY_PATH=. ./tests/correlation_test
    - LD_LIBRARY_PATH=. ./tests/bell_test_demo || true
